{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Concerts</h1>
        <a href="{{ url_for('concert.add') }}" class="btn btn-primary">Add Concert</a>
    </div>
    
    <!-- Future Concerts -->
    <h2>Future Concerts</h2>
    <div class="table-responsive shadow-lg p-3 mb-5 bg-white rounded">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Artist</th>
                    <th scope="col">Venue</th>
                    <th scope="col">Management Email</th>
                    <th scope="col">Management Name</th>
                    <th scope="col">Emailed</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for concert in future_concerts %}
                    <tr id="row_{{ concert.id }}" class = "table-row-scraper">
                        <td><div id="concert_date_{{ concert.id }}" class="editable-content cnt">{{ concert.date }}</div></td>
                        <td><div id="concert_artist_{{ concert.id }}" class="editable-content cnt">{{ concert.artist }}</div></td>
                        <td><div id="concert_venue_{{ concert.id }}" class="editable-content cnt">{{ concert.venue }}</div></td>
                        <td><div id="mgmt_email_{{ concert.id }}" class="editable-content cnt">{{ concert.mgmt_email or '' }}</div></td>
                        <td><div id="mgmt_name_{{ concert.id }}" class="editable-content cnt">{{ concert.mgmt_name or '' }}</div></td>
                        <td>{{ concert.emailed }}</td>
                        <td>
                            <button class="btn btn-primary" id="edit_btn_{{ concert.id }}" onclick="toggleEdit('{{ concert.id }}')">Edit</button>
                            <button class="btn btn-success d-none" id="save_btn_{{ concert.id }}" onclick="saveRow('{{ concert.id }}')">Save</button>
                            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#emailModal" onclick="openEmailModal('{{ concert.id }}')">Email</button>

                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination for Future Concerts -->
    <div class="pagination mb-5">
        {% if page > 1 %}
            <a class="btn btn-secondary" href="{{ url_for('concert.index', page=page-1) }}">Previous</a>
        {% endif %}
        <span>Page {{ page }} of {{ total_pages_future }}</span>
        {% if page < total_pages_future %}
            <a class="btn btn-secondary" href="{{ url_for('concert.index', page=page+1) }}">Next</a>
        {% endif %}
    </div>

    <!-- Past Concerts -->
    <h2>Past Concerts</h2>
    <div class="table-responsive shadow-lg p-3 mb-5 bg-white rounded">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Artist</th>
                    <th scope="col">Venue</th>
                    <th scope="col">Management Email</th>
                    <th scope="col">Management Name</th>
                    <th scope="col">Emailed</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for concert in past_concerts %}
                    <tr id="row_{{ concert.id }}" class = "table-row-scraper">
                        <td><div id="concert_date_{{ concert.id }}" class="editable-content">{{ concert.date }}</div></td>
                        <td><div id="concert_artist_{{ concert.id }}" class="editable-content">{{ concert.artist }}</div></td>
                        <td><div id="concert_venue_{{ concert.id }}" class="editable-content">{{ concert.venue }}</div></td>
                        <td><div id="mgmt_email_{{ concert.id }}" class="editable-content">{{ concert.mgmt_email or '' }}</div></td>
                        <td><div id="mgmt_name_{{ concert.id }}" class="editable-content">{{ concert.mgmt_name or '' }}</div></td>
                        <td>{{ concert.emailed }}</td>
                        <td>
                            <button class="btn btn-primary" id="edit_btn_{{ concert.id }}" onclick="toggleEdit('{{ concert.id }}')">Edit</button>
                            <button class="btn btn-success d-none" id="save_btn_{{ concert.id }}" onclick="saveRow('{{ concert.id }}')">Save</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination for Past Concerts -->
    <div class="pagination mb-5">
        {% if page > 1 %}
            <a class="btn btn-secondary" href="{{ url_for('concert.index', page=page-1) }}">Previous</a>
        {% endif %}
        <span>Page {{ page }} of {{ total_pages_past }}</span>
        {% if page < total_pages_past %}
            <a class="btn btn-secondary" href="{{ url_for('concert.index', page=page+1) }}">Next</a>
        {% endif %}
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="emailModalLabel">Send Email</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="emailForm">
            <div class="mb-3">
              <label for="emailArtist" class="form-label">Artist</label>
              <input type="text" class="form-control" id="emailArtist" readonly>
            </div>
            <div class="mb-3">
              <label for="emailVenue" class="form-label">Venue</label>
              <input type="text" class="form-control" id="emailVenue" readonly>
            </div>
            <div class="mb-3">
              <label for="emailDate" class="form-label">Date</label>
              <input type="text" class="form-control" id="emailDate" readonly>
            </div>
            <div class="mb-3">
              <label for="emailMgmtEmail" class="form-label">Management Email</label>
              <input type="email" class="form-control" id="emailMgmtEmail" readonly>
            </div>
            <div class="mb-3">
              <label for="emailMgmtName" class="form-label">Management Name</label>
              <input type="text" class="form-control" id="emailMgmtName" readonly>
            </div>
            <div class="mb-3">
              <label for="emailMessage" class="form-label">Message</label>
              <textarea class="form-control" id="emailMessage" rows="4"></textarea>
            </div>
            <input type="hidden" id="emailConcertId">
            <button type="button" class="btn btn-primary" onclick="sendEmail()">Send Email</button>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
    function toggleEdit(concertId) {
        const editButton = document.getElementById(`edit_btn_${concertId}`);
        const saveButton = document.getElementById(`save_btn_${concertId}`);
        const row = document.getElementById(`row_${concertId}`);
        const isEditing = saveButton.classList.contains('d-none');

        if (isEditing) {
            // Start editing
            editButton.classList.add('d-none');
            saveButton.classList.remove('d-none');
            row.classList.add('table-warning');

            // Make fields editable
            const fields = [
                `concert_date_${concertId}`,
                `concert_artist_${concertId}`,
                `concert_venue_${concertId}`,
                `mgmt_email_${concertId}`,
                `mgmt_name_${concertId}`
            ];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.contentEditable = true;
                    element.classList.add('editable-content');
                    element.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            saveRow(concertId);
                        }
                    });
                }
            });

            // Gray out other rows and hide their edit buttons
            document.querySelectorAll('tr').forEach(tr => {
                if (tr.id !== `row_${concertId}`) {
                    tr.classList.add('table-secondary');
                    const editBtn = tr.querySelector('.btn-primary');
                    if (editBtn) {
                        editBtn.classList.add('d-none');
                    }
                }
            });
        } else {
            // Stop editing
            editButton.classList.remove('d-none');
            saveButton.classList.add('d-none');
            row.classList.remove('table-warning');

            // Make fields non-editable
            const fields = [
                `concert_date_${concertId}`,
                `concert_artist_${concertId}`,
                `concert_venue_${concertId}`,
                `mgmt_email_${concertId}`,
                `mgmt_name_${concertId}`
            ];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.contentEditable = false;
                    element.classList.remove('editable-content');
                }
            });

            // Restore other rows and show their edit buttons
            document.querySelectorAll('tr').forEach(tr => {
                if (tr.id !== `row_${concertId}`) {
                    tr.classList.remove('table-secondary');
                    const editBtn = tr.querySelector('.btn-primary');
                    if (editBtn) {
                        editBtn.classList.remove('d-none');
                    }
                }
            });
        }
    }


    function saveRow(concertId) {
        const data = {
            concert_date: document.getElementById(`concert_date_${concertId}`).innerText,
            concert_artist: document.getElementById(`concert_artist_${concertId}`).innerText,
            concert_venue: document.getElementById(`concert_venue_${concertId}`).innerText,
            mgmt_email: document.getElementById(`mgmt_email_${concertId}`).innerText,
            mgmt_name: document.getElementById(`mgmt_name_${concertId}`).innerText
        };

        fetch(`/update_management/${concertId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            toggleEdit(concertId); // Exit edit mode
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function openEmailModal(concertId) {
        const concertRow = document.getElementById(`row_${concertId}`);
        
        document.getElementById('emailArtist').value = concertRow.querySelector(`#concert_artist_${concertId}`).innerText;
        document.getElementById('emailVenue').value = concertRow.querySelector(`#concert_venue_${concertId}`).innerText;
        document.getElementById('emailDate').value = concertRow.querySelector(`#concert_date_${concertId}`).innerText;
        document.getElementById('emailMgmtEmail').value = concertRow.querySelector(`#mgmt_email_${concertId}`).innerText;
        document.getElementById('emailMgmtName').value = concertRow.querySelector(`#mgmt_name_${concertId}`).innerText;
        document.getElementById('emailConcertId').value = concertId;
    }

    function sendEmail() {
        const concertId = document.getElementById('emailConcertId').value;
        const message = document.getElementById('emailMessage').value;

        fetch(`/send_email/${concertId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Email sent successfully!');
                document.getElementById('emailForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
            } else {
                alert('Error sending email: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
</script>

<style>
    /* Base styling for all contenteditable elements */
    .editable-content {
        border-radius: 4px; /* Rounded corners */
        background-color: rgba(255, 255, 255, 0); /* Consistent background color */
        box-sizing: border-box; /* Ensure padding/border does not affect width */
        height: 40px; /* Maintain row height */
        vertical-align:middle; /* Center text vertically */
    }

    /* Styling when a row is being edited */
    .table-warning .editable-content {
        background-color: #f9f9f9; /* Slightly different background when editing */
        border: 1px solid #ddd; /* Border to indicate edit mode */
    }

    /* Styling for rows that are not active (when editing) */
    .table-secondary .editable-content {
        background-color: #f8f9fa00; /* Slightly gray background for non-active rows */
    }

    .cnt {
        vertical-align: middle;
    }


</style>

{% endblock %}